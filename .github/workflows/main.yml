name: Sync Latest Release to Gitee

on:
  schedule:
    - cron: '0 2 * * *' # 每天凌晨 2 点检查
  workflow_dispatch:   # 允许手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Sync to Gitee
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO: ${{ secrets.GITEE_REPO }}
          UPSTREAM: KaringX/karing
        run: |
          # 1. 获取原仓库最新版本号
          TAG=$(gh release view --repo $UPSTREAM --json tagName --template '{{.tagName}}')
          echo "Upstream latest tag: $TAG"

          # 2. 检查 Gitee 是否已经存在该版本 (通过返回状态码判断)
          HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" "https://gitee.com/api/v5/repos/${GITEE_REPO}/releases/tags/${TAG}?access_token=${GITEE_TOKEN}")
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Gitee already has version $TAG. Skipping."
          else
            echo "New version $TAG not found on Gitee. Starting migration..."

            # 3. 下载原仓库附件
            mkdir -p dist
            gh release download $TAG --repo $UPSTREAM --dir dist
            # 获取版本说明
            gh release view $TAG --repo $UPSTREAM --json body --template '{{.body}}' > notes.md

            # 4. 在 Gitee 创建 Release
            # 使用 jq 提取创建成功后的 release ID
            RESPONSE=$(curl -X POST "https://gitee.com/api/v5/repos/${GITEE_REPO}/releases" \
              -d "access_token=${GITEE_TOKEN}" \
              -d "tag_name=${TAG}" \
              -d "name=Karing ${TAG}" \
              -d "body=$(cat notes.md | head -c 1000)" \
              -d "target_confirm=master")
            
            RELEASE_ID=$(echo $RESPONSE | jq '.id')

            if [ "$RELEASE_ID" = "null" ]; then
              echo "Failed to create Gitee release. Response: $RESPONSE"
              exit 1
            fi

            # 5. 上传附件到 Gitee
            for file in ./dist/*; do
              filename=$(basename "$file")
              echo "Uploading $filename to Gitee..."
              curl -X POST "https://gitee.com/api/v5/repos/${GITEE_REPO}/releases/${RELEASE_ID}/attach_files" \
                -F "access_token=${GITEE_TOKEN}" \
                -F "file=@$file"
            done
            
            echo "Successfully synced $TAG to Gitee."
          fi
