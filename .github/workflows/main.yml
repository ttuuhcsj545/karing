name: Sync Latest Release to Gitee

on:
  schedule:
    - cron: '0 2 * * *' # 每天凌晨2点自动同步
  workflow_dispatch:    # 支持手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # 只拉取最近一次提交，加快速度

      - name: Sync Process
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO: ${{ secrets.GITEE_REPO }} # 格式如: username/repo
          UPSTREAM: KaringX/karing
        run: |
          # 1. 获取原仓库最新版本号
          TAG=$(gh release view --repo $UPSTREAM --json tagName --template '{{.tagName}}')
          echo "Target Tag: $TAG"

          # 2. 准备 Gitee 远程仓库
          GITEE_USER=$(echo ${GITEE_REPO} | cut -d'/' -f1)
          git remote add gitee "https://${GITEE_USER}:${GITEE_TOKEN}@gitee.com/${GITEE_REPO}.git"

          # 3. 精准同步：仅抓取当前需要的这一个 Tag，避免拉取数百个历史 Tag 导致中断
          echo "Fetching specific tag from GitHub..."
          git fetch https://github.com/${UPSTREAM}.git refs/tags/${TAG}:refs/tags/${TAG}
          
          echo "Pushing code and the specific tag to Gitee..."
          # 推送代码到 master 分支
          git push gitee HEAD:master --force || true
          # 推送目标 Tag 到 Gitee
          git push gitee ${TAG} --force || true

          # 4. 下载 GitHub Release 附件
          echo "Downloading assets from GitHub..."
          mkdir -p dist
          rm -rf dist/*
          gh release download $TAG --repo $UPSTREAM --dir dist

          # 5. Gitee Release 预处理
          # 检查 Gitee 是否已存在同名 Release，若存在则删除，以便重新同步附件
          echo "Checking existing release on Gitee..."
          EXISTING_ID=$(curl -s "https://gitee.com/api/v5/repos/${GITEE_REPO}/releases/tags/${TAG}?access_token=${GITEE_TOKEN}" | jq -r '.id // empty')
          
          if [ -n "$EXISTING_ID" ] && [ "$EXISTING_ID" != "null" ]; then
             echo "Deleting existing Gitee release ID: $EXISTING_ID"
             curl -X DELETE "https://gitee.com/api/v5/repos/${GITEE_REPO}/releases/${EXISTING_ID}?access_token=${GITEE_TOKEN}"
          fi

          # 6. 创建 Gitee Release
          echo "Creating new release on Gitee..."
          CREATE_RESPONSE=$(curl -X POST "https://gitee.com/api/v5/repos/${GITEE_REPO}/releases" \
            -d "access_token=${GITEE_TOKEN}" \
            -d "tag_name=${TAG}" \
            -d "name=Karing-${TAG}" \
            -d "body=Synced from GitHub ${UPSTREAM}" \
            -d "target_confirm=master")
          
          RELEASE_ID=$(echo $CREATE_RESPONSE | jq -r '.id // empty')

          if [ -z "$RELEASE_ID" ] || [ "$RELEASE_ID" = "null" ]; then
            echo "Error: Failed to create Gitee release. Response: $CREATE_RESPONSE"
            exit 1
          fi

          # 7. 上传附件到 Gitee (限制 100MB)
          echo "Uploading assets to Gitee..."
          for file in ./dist/*; do
            filename=$(basename "$file")
            filesize=$(stat -c%s "$file")
            
            # Gitee 免费版单个附件限制 100MB (104857600 字节)
            if [ $filesize -gt 104857600 ]; then
              echo "Skipping $filename - Size $((filesize/1024/1024))MB exceeds Gitee 100MB limit."
              continue
            fi
            
            echo "Uploading $filename ($((filesize/1024/1024))MB)..."
            curl -X POST "https://gitee.com/api/v5/repos/${GITEE_REPO}/releases/${RELEASE_ID}/attach_files" \
              -F "access_token=${GITEE_TOKEN}" \
              -F "file=@$file"
          done

          echo "Done! Sync completed for $TAG"
