name: Sync Latest Release to Gitee

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync Process
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO: ${{ secrets.GITEE_REPO }}
          UPSTREAM: KaringX/karing
        run: |
          # 1. 获取原仓库最新版本号
          TAG=$(gh release view --repo $UPSTREAM --json tagName --template '{{.tagName}}')
          echo "Target Tag: $TAG"

          # 2. Git 认证与推送 (加入容错)
          echo "Pushing code and tags to Gitee..."
          GITEE_USER=$(echo ${GITEE_REPO} | cut -d'/' -f1)
          git remote remove gitee 2>/dev/null || true
          git remote add gitee "https://${GITEE_USER}:${GITEE_TOKEN}@gitee.com/${GITEE_REPO}.git"
          
          # 即使分支或 Tag 已存在，也不报错停止
          git push gitee HEAD:master --force || true
          git fetch --tags https://github.com/${UPSTREAM}.git
          git push gitee $TAG --force || true

          # 3. 下载附件
          echo "Downloading assets from GitHub..."
          mkdir -p dist
          rm -rf dist/*
          gh release download $TAG --repo $UPSTREAM --dir dist
          
          # 4. 在 Gitee 创建/更新 Release 记录
          # 先检查 Gitee 是否已有该 Release
          EXISTING_ID=$(curl -s "https://gitee.com/api/v5/repos/${GITEE_REPO}/releases/tags/${TAG}?access_token=${GITEE_TOKEN}" | jq -r '.id // empty')
          
          if [ -n "$EXISTING_ID" ] && [ "$EXISTING_ID" != "null" ]; then
             echo "Deleting existing release ID: $EXISTING_ID to ensure fresh sync."
             curl -X DELETE "https://gitee.com/api/v5/repos/${GITEE_REPO}/releases/${EXISTING_ID}?access_token=${GITEE_TOKEN}"
          fi

          echo "Creating new release on Gitee..."
          RESPONSE=$(curl -X POST "https://gitee.com/api/v5/repos/${GITEE_REPO}/releases" \
            -d "access_token=${GITEE_TOKEN}" \
            -d "tag_name=${TAG}" \
            -d "name=Karing-${TAG}" \
            -d "body=Synced-from-GitHub-KaringX" \
            -d "target_confirm=master")
          
          RELEASE_ID=$(echo $RESPONSE | jq -r '.id // empty')

          if [ -z "$RELEASE_ID" ] || [ "$RELEASE_ID" = "null" ]; then
            echo "Error: Failed to create Gitee release. Response: $RESPONSE"
            exit 1
          fi

          # 5. 上传附件 (跳过 >100MB 文件)
          echo "Starting file upload..."
          for file in ./dist/*; do
            filename=$(basename "$file")
            filesize=$(stat -c%s "$file")
            if [ $filesize -gt 104857600 ]; then
              echo "Skipping $filename ($((filesize/1024/1024))MB) - Exceeds Gitee 100MB limit."
              continue
            fi
            
            echo "Uploading $filename..."
            # Gitee 上传附件 API
            curl -X POST "https://gitee.com/api/v5/repos/${GITEE_REPO}/releases/${RELEASE_ID}/attach_files" \
              -F "access_token=${GITEE_TOKEN}" \
              -F "file=@$file"
          done

          echo "Success! All compatible assets synced to Gitee."
